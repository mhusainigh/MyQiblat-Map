<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyQiblat Pro - Precision Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #app-container { display: flex; height: 100vh; flex-direction: row; }
        #sidebar { width: 440px; background: white; padding: 25px; overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.1); z-index: 1001; }
        #map { flex-grow: 1; height: 100%; z-index: 1; background: #e5e3df; position: relative; }
        .header-title { color: #1a5d1a; font-weight: bold; border-bottom: 3px solid #1a5d1a; padding-bottom: 5px; margin-bottom: 20px; }
        .result-box { background: #fdfdfd; border: 1px solid #c3e6cb; border-radius: 12px; padding: 20px; margin-top: 15px; display: none; }
        
        .search-container { position: relative; margin-bottom: 15px; }
        #search-results { position: absolute; width: 100%; background: white; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; display: none; }
        .search-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .search-item:hover { background: #f8f9fa; }

        .map-controls-group { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .map-btn { background: white; width: 46px; height: 46px; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; border: 1px solid #ddd; }
        .sensor-active { background-color: #ffc107 !important; border-color: #d39e00; }
        #compass-needle-svg { width: 36px; height: 36px; transition: transform 0.1s linear; }

        .tool-note { font-size: 0.75rem; background: #f1f3f5; padding: 8px; border-radius: 6px; display: block; margin-top: 6px; color: #333; border-left: 4px solid #1a5d1a; line-height: 1.4; }
        @media (max-width: 768px) { #app-container { flex-direction: column; } #sidebar { width: 100%; height: 55%; } #map { height: 45%; } }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar">
        <h2 class="header-title">MyQiblat Pro</h2>
        
        <div class="search-container">
            <label class="form-label fw-bold small">Carian Alamat / POI / Koordinat (U, S, T, B):</label>
            <div class="input-group">
                <input type="text" id="unifiedInput" class="form-control" placeholder="Cari tempat atau koordinat..." autocomplete="off">
                <button class="btn btn-primary" onclick="handleSearch()"><span class="material-icons">search</span></button>
            </div>
            <div id="search-results"></div>
        </div>

        <div class="row g-2 mb-3 align-items-end">
            <div class="col-6">
                <label class="form-label fw-bold small">Tahun (WMM):</label>
                <div class="input-group">
                    <input type="number" id="yearInput" class="form-control" disabled>
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="checkbox" id="autoYearToggle" checked onchange="toggleYearMode()">
                        <span class="ms-1 small">Auto</span>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <button class="btn btn-success w-100 fw-bold" onclick="handleSearch()"><span class="material-icons align-middle fs-6">explore</span> Hitung Kiblat</button>
            </div>
        </div>

        <div id="result" class="result-box">
            <h6 class="fw-bold text-success border-bottom pb-2 mb-3">DATA GEODESIK</h6>
            <div class="small mb-2">
                <p class="mb-1"><strong>Lokasi:</strong> <span id="resLoc" class="badge bg-secondary"></span></p>
                <p class="mb-1"><strong>Koordinat Lokasi:</strong> <br><span id="resCoord"></span></p>
                <p class="mb-1"><strong>Koordinat Kaabah:</strong> <br>21° 25' 20.95" U, 39° 49' 34.34" T</p>
                <p class="mb-2"><strong>Jarak Geodesik:</strong> <span id="resDist"></span></p>
            </div>
            <hr>
            <div class="mb-3">
                <p class="mb-0 fw-bold text-danger">Azimuth Sebenar (Utara Benar):</p>
                <p id="valTrue" class="mb-0 fw-bold fs-5 text-dark"></p>
                <span class="tool-note"><strong>Kegunaan:</strong> Sistem GPS, Peta Digital (Google Earth/Maps), Alat Total Station (Ukur Tanah) & Penentuan Arah Kiblat Kekal.</span>
            </div>
            <div class="mb-3">
                <p class="mb-0 fw-bold text-primary" id="magLabel">Bearing Magnetik (WMM):</p>
                <p id="valMag" class="mb-0 fw-bold fs-5 text-dark"></p>
                <span id="valDec" class="text-muted small d-block mb-1"></span>
                <span class="tool-note"><strong>Kegunaan:</strong> Kompas Analog (Prismatik/Baseplate), Kompas Kiblat & Sensor Kompas pada telefon pintar.</span>
            </div>
            <div class="d-flex gap-2 mb-2">
                <button class="btn btn-warning text-white btn-sm w-50 fw-bold" onclick="openStreetView()">Street View</button>
                <button class="btn btn-primary btn-sm w-50 fw-bold" onclick="takeScreenshot()">Screenshot</button>
            </div>
            <button class="btn btn-outline-danger btn-sm w-100 fw-bold" onclick="downloadKML()">Cipta Azimuth Kiblat KML</button>
        </div>
        <div class="footer mt-4 text-center small text-muted" id="dynamicFooter">Inisialisasi...</div>
    </div>

    <div id="map">
        <div class="map-controls-group">
            <button class="map-btn" onclick="locateUser()"><span class="material-icons text-primary">my_location</span></button>
            <button id="compass-btn" class="map-btn" onclick="handleCompassAction()">
                 <svg id="compass-needle-svg" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="white" stroke="#1a5d1a" stroke-width="2"/>
                    <path d="M50 10 L40 50 L50 90 L60 50 Z" fill="#e74c3c"/>
                    <path d="M50 10 L50 50 L60 50 Z" fill="#c0392b"/>
                    <text x="50" y="30" text-anchor="middle" font-family="Arial" font-weight="bold" font-size="14" fill="#1a5d1a">N</text>
                </svg>
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/Raruto/leaflet-rotate@1.0.1/dist/leaflet-rotate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
    const KAABA = { lat: 21.42248611, lon: 39.82620556 };
    let map, userMarker, lineQibla, isCompassActive = false, currentCoords = null, searchTimeout;
    let currentLocLabel = "";

    function initMap() {
        map = L.map('map', { rotate: true, touchRotate: true, zoomControl: false }).setView([4.21, 101.97], 6);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        document.getElementById('yearInput').value = new Date().getFullYear();

        map.on('rotate', () => { document.getElementById('compass-needle-svg').style.transform = `rotate(${-map.getBearing()}deg)`; });

        // Klik Kanan / Tahan pada Peta
        map.on('contextmenu', (e) => { 
            currentCoords = { lat: e.latlng.lat, lon: e.latlng.lng }; 
            currentLocLabel = "Titik Pilihan (Peta)";
            document.getElementById('unifiedInput').value = `${currentCoords.lat.toFixed(8)}, ${currentCoords.lon.toFixed(8)}`;
            updateUIFromCoords(); 
        });

        document.getElementById('unifiedInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            if (query.length < 3) return hideSuggestions();
            searchTimeout = setTimeout(() => fetchSuggestions(query), 500);
        });
    }

    async function fetchSuggestions(query) {
        const resBox = document.getElementById('search-results');
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
            const data = await res.json();
            if (data.length === 0) return hideSuggestions();
            resBox.innerHTML = data.map(item => `<div class="search-item" onclick="selectSuggestion(${item.lat}, ${item.lon}, '${item.display_name.replace(/'/g, "\\'")}')">${item.display_name}</div>`).join('');
            resBox.style.display = 'block';
        } catch (e) { hideSuggestions(); }
    }

    function selectSuggestion(lat, lon, name) {
        currentCoords = { lat, lon };
        currentLocLabel = name.split(',')[0];
        document.getElementById('unifiedInput').value = name;
        hideSuggestions();
        updateUIFromCoords();
    }

    function hideSuggestions() { document.getElementById('search-results').style.display = 'none'; }

    function toggleYearMode() {
        const auto = document.getElementById('autoYearToggle').checked;
        const input = document.getElementById('yearInput');
        input.disabled = auto;
        if (auto) input.value = new Date().getFullYear();
        if (currentCoords) updateUIFromCoords();
    }

    async function updateUIFromCoords() {
        if (!currentCoords) return;
        const lat = currentCoords.lat, lon = currentCoords.lon;
        const year = parseInt(document.getElementById('yearInput').value);
        
        const modelYear = Math.floor(year / 5) * 5;
        document.getElementById('magLabel').innerText = `Bearing Magnetik (WMM${modelYear}):`;

        const φ1 = lat * Math.PI/180, φ2 = KAABA.lat * Math.PI/180, Δλ = (KAABA.lon - lon) * Math.PI/180;
        const trueAz = (Math.atan2(Math.sin(Δλ), Math.cos(φ1)*Math.tan(φ2) - Math.sin(φ1)*Math.cos(Δλ)) * 180 / Math.PI + 360) % 360;
        const distKm = L.latLng(lat, lon).distanceTo(L.latLng(KAABA.lat, KAABA.lon)) / 1000;
        
        let dec = -0.19; 
        document.getElementById('valDec').innerText = "Mendapatkan data NOAA...";
        try {
            const res = await fetch(`https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${lat}&lon1=${lon}&resultFormat=json&startYear=${year}`);
            const data = await res.json();
            dec = data.result[0].declination;
            document.getElementById('valDec').innerText = `Deklinasi Magnetik (${year}): ${dec.toFixed(2)}° (${dec < 0 ? 'Barat' : 'Timur'})`;
        } catch(e) {
            document.getElementById('valDec').innerText = `Deklinasi (Anggaran Malaysia ${year}): ${dec.toFixed(2)}° (Barat)`;
        }

        const magAz = (trueAz - dec + 360) % 360;
        const ptsCount = Math.max(10, Math.floor(distKm / 50));

        document.getElementById('result').style.display = 'block';
        document.getElementById('resLoc').innerText = currentLocLabel;
        document.getElementById('resCoord').innerText = `${ddToDms(lat, true)}, ${ddToDms(lon, false)}`;
        document.getElementById('resDist').innerText = distKm.toFixed(2) + " km";
        document.getElementById('valTrue').innerText = `${ddToDms(trueAz, false)} (${trueAz.toFixed(6)}°)`;
        document.getElementById('valMag').innerText = `${ddToDms(magAz, false)} (${magAz.toFixed(6)}°)`;
        document.getElementById('dynamicFooter').innerText = `Geodesic Path (${ptsCount} pts) | WMM-${modelYear} Dynamic Engine`;

        if(userMarker) map.removeLayer(userMarker);
        if(lineQibla) map.removeLayer(lineQibla);
        userMarker = L.marker([lat, lon]).addTo(map).bindPopup(currentLocLabel);
        lineQibla = L.polyline(calculateGeodesicPath(currentCoords, KAABA, ptsCount), {color: 'red', weight: 4}).addTo(map);
        map.setView([lat, lon], 17);
    }

    function calculateGeodesicPath(start, end, segments) {
        const pts = [];
        const lat1 = start.lat * Math.PI/180, lon1 = start.lon * Math.PI/180, lat2 = end.lat * Math.PI/180, lon2 = end.lon * Math.PI/180;
        const d = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin((lat1-lat2)/2),2) + Math.cos(lat1)*Math.cos(lat2)*Math.pow(Math.sin((lon1-lon2)/2),2)));
        for (let i = 0; i <= segments; i++) {
            const f = i / segments;
            const A = Math.sin((1-f)*d)/Math.sin(d), B = Math.sin(f*d)/Math.sin(d);
            const x = A*Math.cos(lat1)*Math.cos(lon1) + B*Math.cos(lat2)*Math.cos(lon2), y = A*Math.cos(lat1)*Math.sin(lon1) + B*Math.cos(lat2)*Math.sin(lon2), z = A*Math.sin(lat1) + B*Math.sin(lat2);
            pts.push([Math.atan2(z, Math.sqrt(x*x+y*y))*180/Math.PI, Math.atan2(y,x)*180/Math.PI]);
        }
        return pts;
    }

    function handleSearch() {
        const input = document.getElementById('unifiedInput').value.trim();
        const coords = parseCoords(input);
        if (coords) { 
            currentCoords = coords; 
            currentLocLabel = "Koordinat Input";
            updateUIFromCoords(); 
        } 
        else { fetchSuggestions(input); }
    }

    function parseCoords(input) {
        const normalized = input.toUpperCase().replace(/U/g, 'N').replace(/S/g, 'S').replace(/T/g, 'E').replace(/B/g, 'W');
        const dmsRegex = /(\d+)\s*[°]\s*(\d+)\s*[']\s*([\d.]+)\s*["]?\s*([NSEW])/gi;
        let m = [...normalized.matchAll(dmsRegex)];
        if (m.length >= 2) {
            const conv = (p) => {
                let d = parseFloat(p[1]) + (parseFloat(p[2]) / 60) + (parseFloat(p[3]) / 3600);
                if (['S','W'].includes(p[4])) d = -d;
                return d;
            };
            return { lat: conv(m[0]), lon: conv(m[1]) };
        }
        const ddMatch = normalized.match(/([-+]?\d+\.\d+)\s*[,\s]\s*([-+]?\d+\.\d+)/);
        return ddMatch ? { lat: parseFloat(ddMatch[1]), lon: parseFloat(ddMatch[2]) } : null;
    }

    function ddToDms(dd, isLat) {
        const abs = Math.abs(dd), d = Math.floor(abs), m = Math.floor((abs-d)*60), s = ((abs-d-m/60)*3600).toFixed(2);
        const suffix = isLat ? (dd>=0?'U':'S') : (dd>=0?'T':'B');
        return `${d}° ${m}' ${s}" ${suffix}`;
    }

    function downloadKML() {
        if(!currentCoords) return alert("Sila pilih lokasi terlebih dahulu.");
        // Ambil label terkini untuk nama fail
        const fileName = currentLocLabel.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Azimuth Kiblat - ${currentLocLabel}</name>
    <Style id="redLine"><LineStyle><color>ff0000ff</color><width>4</width></LineStyle></Style>
    <Placemark><name>Lokasi: ${currentLocLabel}</name><Point><coordinates>${currentCoords.lon},${currentCoords.lat},0</coordinates></Point></Placemark>
    <Placemark><name>Kaabah</name><Point><coordinates>${KAABA.lon},${KAABA.lat},0</coordinates></Point></Placemark>
    <Placemark><name>Garisan Azimuth Kiblat</name><styleUrl>#redLine</styleUrl>
    <LineString><tessellate>1</tessellate><coordinates>${currentCoords.lon},${currentCoords.lat},0 ${KAABA.lon},${KAABA.lat},0</coordinates></LineString></Placemark>
  </Document>
</kml>`;
        const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Azimuth_Kiblat_${fileName}.kml`; a.click();
    }

    function handleCompassAction() { if (map.getBearing() !== 0 && !isCompassActive) map.setBearing(0); else toggleCompass(); }
    async function toggleCompass() { 
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            try { await DeviceOrientationEvent.requestPermission(); } catch(e) { return alert("Sensor memerlukan HTTPS."); }
        }
        isCompassActive = !isCompassActive; 
        const btn = document.getElementById('compass-btn'); 
        if (isCompassActive) { 
            btn.classList.add('sensor-active'); 
            window.addEventListener('deviceorientationabsolute', orientationHandler, true); 
        } else { 
            btn.classList.remove('sensor-active'); 
            window.removeEventListener('deviceorientationabsolute', orientationHandler, true);
            map.setBearing(0); 
        } 
    }
    function orientationHandler(e) { if (!isCompassActive) return; let h = e.webkitCompassHeading || (360 - e.alpha); if (h) map.setBearing(h); }

    function locateUser() { 
        map.locate({setView: true, maxZoom: 18}); 
        map.once('locationfound', (e) => { 
            currentCoords = { lat: e.latlng.lat, lon: e.latlng.lng }; 
            currentLocLabel = "Lokasi GPS Semasa";
            updateUIFromCoords(); 
        }); 
        map.once('locationerror', () => alert("Gagal mendapatkan lokasi. Pastikan GPS aktif dan menggunakan HTTPS."));
    }
    
    function openStreetView() { window.open(`http://maps.google.com/maps?q=&layer=c&cbll=${currentCoords.lat},${currentCoords.lon}`, '_blank'); }
    function takeScreenshot() { html2canvas(document.body).then(canvas => { const a = document.createElement('a'); a.download = `MyQiblat_Pro_Result.png`; a.href = canvas.toDataURL(); a.click(); }); }

    window.onload = initMap;
</script>
</body>
</html>
